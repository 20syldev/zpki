<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificates Manager</title>
    <link rel="icon" type="image/png" href="logo.png"/>
    <!-- CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap');
        * {
            font-family: 'Poppins', sans-serif;
            scroll-behavior: smooth;
        }

        .container-fluid {
            width: 100%;
            padding: 0;
        }
        
        #certForm {
            position: sticky;
            top: 0;
            width: 100%;
            height: 130px;
            padding: 15px;
            background: #fefefe;
            z-index: 99;
        }

        .form-group {
            display: flex;
            align-items: center;
        }

        .dropdown-toggle {
            white-space: nowrap; 
        }

        .dropdown-menu {
            margin-top: 7px;
            border: 1px solid #ddd;
            cursor: pointer;
            z-index: 999;
        }

        .cert-checkbox {
            cursor: pointer;
            transition: 0.3s;
        }
        .cert-checkbox.active {
            opacity: 0.5;
        }

        .btn {
            opacity: 0.9;
            margin-top: 3px;
            font-weight: 500;
        }
        .btn[disabled] {
            cursor: not-allowed;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-inner {
            padding: 10px 15px;
            max-width: 500px;
            line-height: 1.8em;
            border-radius: 10px;
        }

        /* Table */
        thead {
            position: sticky;
            top: 130px;
            background: #fefefe;
            text-align: center;
            z-index: 1;
        }

        thead::after {
            content: "";
            display: block;
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            height: 120px;
            background: #fefefe;
            box-shadow: 0 6px 6px rgba(0, 0, 0, 0.1);
            z-index: -1;
        }

        table {
            text-align: center;
        }

        th, td {
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        th.resizable {
            resize: horizontal;
            overflow: auto;
        }

        th.resizable:hover {
            background: #fafafa;
            border-radius: 10px;
        }

        ::-webkit-scrollbar {
            display: none;
        }
        
    </style>
</head>
<body>
    <div class="container-fluid">
        <span class="block"></span>

        <form id="certForm">
            <div class="form-group">

                <!-- Create a certificate -->
                <div class="dropdown mr-2">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-plus"></i>
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" data-count="1">1 Certificate</a>
                        <a class="dropdown-item" data-count="10">10 Certificates</a>
                        <a class="dropdown-item" data-count="100">100 Certificates</a>
                        <a class="dropdown-item" data-count="1000">1000 Certificates</a>
                    </div>
                </div>
                <input type="hidden" id="certCount" value="">

                <!-- Certificate name input -->
                <input type="text" id="certName" class="form-control mr-2" placeholder="Certificate name (ex: John Doe)">

                <!-- Search Bar -->
                <input type="text" id="certSearch" class="form-control" placeholder="Search for a certificate">
            </div>
            
            <!-- Actions -->
            <div id="actionButtons" class="action-buttons">
                <button id="revokeSelected" class="btn btn-dark btn-sm" hidden>
                    <i class="mr-1 fa fa-ban"></i> Revoke
                </button>
                <button id="renewSelected" class="btn btn-dark btn-sm" hidden>
                    <i class="mr-1 fa fa-rotate-right"></i> Renew
                </button>
                <button id="refresh" class="btn btn-secondary btn-sm float-right">
                    <i class="mr-1 fa fa-sync-alt"></i> Refresh
                </button>
            </div>
        </form>

        <!-- Table header -->
        <table class="table table-bordered table-striped">
            <thead class="thead">
                <tr>
                    <th class="resizable" scope="col" data-sort="selectBox"><div class="sortable-handle"><i class="fa fa-square-check"></i></div></th>
                    <th class="resizable" scope="col" data-sort="validity"><div class="sortable-handle"><i class="fa fa-chart-simple"></i></div></th>
                    <th class="resizable" scope="col" data-sort="serial"><div class="sortable-handle"><i class="mr-1 fa fa-hashtag"></i> Serial</div></th>
                    <th class="resizable" scope="col" data-sort="startDate"><div class="sortable-handle"><i class="mr-1 fa fa-calendar-day"></i> Start Date</div></th>
                    <th class="resizable" scope="col" data-sort="endDate"><div class="sortable-handle"><i class="mr-1 fa fa-calendar-alt"></i> End Date</div></th>
                    <th class="resizable" scope="col" data-sort="id"><div class="sortable-handle"><i class="mr-1 fa fa-file-alt"></i> ID</div></th>
                    <th class="resizable" scope="col" data-sort="actions"><div class="sortable-handle"><i class="mr-1 fa fa-cogs"></i> Actions</div></th>
                    <th class="resizable" scope="col" data-sort="downloads"><div class="sortable-handle"><i class="mr-1 fa fa-download"></i> Downloads</div></th>
                </tr>
            </thead>
            <tbody id="certTableBody">
                <!-- Certificates Data -->
            </tbody>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/js/all.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownItems = document.querySelectorAll('.dropdown-item');
            const dropdownButton = document.getElementById('dropdownMenuButton');
            const certCountInput = document.getElementById('certCount');
            const certNameInput = document.getElementById('certName');
            const certSearchInput = document.getElementById('certSearch');
            const certTableBody = document.getElementById('certTableBody');
            const refreshButton = document.getElementById('refresh');
            const renewSelectedButton = document.getElementById('renewSelected');
            const revokeSelectedButton = document.getElementById('revokeSelected');

            // Check if input is empty or not
            function toggleCreateButton() {
                if (certNameInput.value.trim() === "") {
                    dropdownButton.disabled = true;
                } else {
                    dropdownButton.disabled = false;
                }
            }
            toggleCreateButton();

            // Initialize tool tips
            function initializeTooltips() {
                $('[data-toggle="tooltip"]').tooltip({
                    html: true
                });
            }

            // Adapt name, normalize
            function encodeName(name) {
                return name
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/[^a-z0-9-_]/g, '');
            }

            // Format date to YYYY/MM/DD from ISO format
            function formatDate(isoDateString) {
                const date = new Date(isoDateString);
                return date.toLocaleDateString('fr-CA');
            }
            
            // Update actions buttons
            function updateActionButtons() {
                const selectedCerts = document.querySelectorAll('.cert-checkbox.active');
                if (selectedCerts.length > 0) {
                    revokeSelectedButton.hidden = false;
                    renewSelectedButton.hidden = false;
                } else {
                    revokeSelectedButton.hidden = true;
                    renewSelectedButton.hidden = true;
                }
            }

            // Get validity order in sort
            function getValidityOrder(status) {
                switch (status) {
                    case 'V': return 1; // Valid
                    case 'I': return 2; // Invalid
                    case 'R': return 3; // Revoked
                    default: return 4; // Unknown
                }
            }

            function sortTable(columnIndex, order) {
                const rows = Array.from(certTableBody.querySelectorAll('tr'));                
                rows.sort((a, b) => {
                    const cellA = a.querySelector(`td:nth-child(${columnIndex})`);
                    const cellB = b.querySelector(`td:nth-child(${columnIndex})`);

                    if (columnIndex === 1) {
                        const statusA = cellA.querySelector('button').getAttribute('data-status');
                        const statusB = cellB.querySelector('button').getAttribute('data-status');

                        const orderA = getValidityOrder(statusA);
                        const orderB = getValidityOrder(statusB);
                        
                        if (order === 'asc') {
                            return orderA - orderB;
                        } else {
                            return orderB - orderA;
                        }
                    } else {
                        const textA = cellA.textContent.trim();
                        const textB = cellB.textContent.trim();
                        if (order === 'asc') {
                            return textA.localeCompare(textB, undefined, { numeric: true });
                        } else {
                            return textB.localeCompare(textA, undefined, { numeric: true });
                        }
                    }
                });

                rows.forEach(row => certTableBody.appendChild(row));
            }

            // Load data from files, update table & check checkboxes
            function loadCertData() {
                fetch('/list')
                    .then(response => response.json())
                    .then(data => {
                        certTableBody.innerHTML = '';
                        data.forEach(cert => {
                            const status = cert.status;
                            const validityColor = status === 'I' ? 'warning' : (status !== 'R' ? 'success' : 'danger');
                            const validityText = status === 'I' ? 'Invalid' : (status !== 'R' ? 'Valid' : 'Revoked');
                            const validityBtn = status === 'I' ? '<i class="mr-1 fa fa-triangle-exclamation"></i> Invalid' : (status !== 'R' ? '<i class="mr-1 fa fa-circle-check"></i> Valid' : '<i class="mr-1 fa fa-times-circle"></i> Revoked');

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><button class="btn btn-dark btn-sm cert-checkbox"><i class="fa fa-minus"></i></button></td>
                                <td><button class="btn btn-${validityColor} btn-sm" data-id="${cert.id}">${validityBtn}</button></td>
                                <td>
                                    <span class="tooltip-container" data-toggle="tooltip" data-html="true" data-placement="bottom" 
                                    title="<div>Signature: ${cert.signature}</div>">
                                        ${cert.serial}
                                    </span>
                                </td>
                                <td>
                                    <span class="tooltip-container" data-toggle="tooltip" data-placement="bottom" title="${cert.startDate}">${formatDate(cert.startDate)}</span>
                                </td>
                                <td>
                                    <span class="tooltip-container" data-toggle="tooltip" data-placement="bottom" title="${cert.endDate}">${formatDate(cert.endDate)}</span>
                                </td>
                                <td>${cert.id}</td>
                                <td>
                                    <button class="btn btn-dark btn-sm" onclick="revokeCert('${cert.id}')" ${status === 'R' ? 'disabled' : ''}><i class="mr-1 fa fa-ban"></i> Revoke</button>
                                    <button class="btn btn-dark btn-sm" onclick="renewCert('${cert.id}')" ${status === 'R' ? 'disabled' : ''}><i class="mr-1 fa fa-rotate-right"></i> Renew</button>
                                </td>
                                <td>
                                    <a class="btn btn-info btn-sm" href="/src/certs/${cert.id}.crt" download><i class="mr-1 fas fa-file-download"></i> .crt</a>
                                    <a class="btn btn-info btn-sm" href="/src/certs/${cert.id}.csr" download><i class="mr-1 fas fa-file-download"></i> .csr</a>
                                    <a class="btn btn-info btn-sm" href="/src/private/${cert.id}.key" download><i class="mr-1 fas fa-file-download"></i> .key</a>
                                </td>
                            `;
                            certTableBody.appendChild(row);
                        });
                        
                        const certButtons = document.querySelectorAll('.cert-checkbox');
                        certButtons.forEach(button => {
                            button.addEventListener('click', function() {
                                this.classList.toggle('active');
                                updateActionButtons();

                                if (this.classList.contains('active')) {
                                    this.innerHTML = '<i class="fa fa-check"></i>';
                                } else {
                                    this.innerHTML = '<i class="fa fa-minus"></i>';
                                }
                            });
                        });
                        updateActionButtons();
                        initializeTooltips();
                    })
                    .catch(error => console.error('Certificate loading error:', error));
            }

            // Update create button based on input
            certNameInput.addEventListener('input', toggleCreateButton);

            // Dropdown menu to generate a specific number of certificates
            dropdownItems.forEach(item => {
                item.addEventListener('click', function() {
                    const certCount = this.getAttribute('data-count');
                    const certName = encodeName(certNameInput.value);
                    certCountInput.value = certCount;

                    dropdownButton.setAttribute('disabled', 'true');

                    // Request create a certificate
                    fetch(`/create?name=${encodeURIComponent(certName)}&count=${certCount}`)
                        .then(response => response.text())
                        .catch(error => {
                            console.error('Error:', error);
                        })
                        .finally(() => {
                            setTimeout(() => {
                                dropdownButton.removeAttribute('disabled');
                            }, 3000);
                        });
                });
            });

            // Filter certificates by name
            certSearchInput.addEventListener('input', function() {
                const searchText = encodeName(this.value).toLowerCase();
                const rows = certTableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    let match = false;
                    cells.forEach(cell => {
                        if (encodeName(cell.textContent).toLowerCase().includes(searchText)) {
                            match = true;
                        }
                    });
                    row.style.display = match ? '' : 'none';
                });
            });
            
            // Refreshing the table
            refreshButton.addEventListener('click', function(event) {
                event.preventDefault();
                loadCertData();
                refreshButton.classList.add('btn-success');
                refreshButton.innerHTML = '<i class="mr-1 fa fa-square-check"></i> Done!';
                
                setTimeout(() => {
                    refreshButton.innerHTML = '<i class="mr-1 fa fa-sync-alt"></i> Refresh';
                    refreshButton.classList.remove('btn-success');
                }, 1300);
            });

            // Renew multiple certificates
            renewSelectedButton.addEventListener('click', function() {
                event.preventDefault();
                const selectedCerts = Array.from(document.querySelectorAll('.cert-checkbox.active')).map(button => button.getAttribute('data-id'));
                if (selectedCerts.length > 0) {
                    fetch('/renew', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: selectedCerts })
                    })
                    .then(response => response.text())
                    .then(() => loadCertData())
                    .catch(error => console.error('Renewal error:', error));
                }
            });

            // Revoke multiple certificates
            revokeSelectedButton.addEventListener('click', function() {
                event.preventDefault();
                const selectedCerts = Array.from(document.querySelectorAll('.cert-checkbox.active')).map(button => button.getAttribute('data-id'));
                if (selectedCerts.length > 0) {
                    fetch('/revoke', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: selectedCerts })
                    })
                    .then(response => response.text())
                    .then(() => loadCertData())
                    .catch(error => console.error('Revocation error:', error));
                }
            });

            // JQuery
            $(document).ready(function() {
                $("table thead").sortable({
                        items: 'th',
                        handle: '.sortable-handle',
                        cursor: 'move',
                        axis: 'x',
                        start: function(event, ui) {
                            ui.placeholder.height(ui.helper.outerHeight());
                        },
                        stop: function(event, ui) {
                            const newOrder = $("table thead th").map(function() {
                                return $(this).index();
                            }).get();

                            $("table thead").html(
                                $("table thead th").sort(function(a, b) {
                                    return newOrder[$(a).index()] - newOrder[$(b).index()];
                                }).toArray()
                            );

                            $("table tbody").each(function() {
                                $(this).children("tr").each(function() {
                                    const cells = $(this).children("td").toArray();
                                    const reorderedCells = newOrder.map(index => cells[index]);
                                    $(this).empty().append(reorderedCells);
                                });
                            });
                        }
                }).disableSelection();
            });

            // Sorting columns
            document.querySelectorAll('thead th').forEach((header, index) => {
                header.addEventListener('click', function() {
                    const currentOrder = this.classList.contains('asc') ? 'desc' : 'asc';
                    sortTable(index + 1, currentOrder);
                    document.querySelectorAll('thead th').forEach(th => th.classList.remove('asc', 'desc'));
                    this.classList.add(currentOrder);
                });
            });

            // Renew one certificate
            window.renewCert = function(id) {
                fetch('/renew', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: [id] })
                })
                .then(response => response.text())
                .then(() => loadCertData())
                .catch(error => console.error('Renewal error:', error));
            };

            // Revoke one certificate
            window.revokeCert = function(id) {
                fetch('/revoke', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: [id] })
                })
                .then(response => response.text())
                .then(() => loadCertData())
                .catch(error => console.error('Revocation error:', error));
            };

            loadCertData();
        });
    </script>
</body>
</html>
